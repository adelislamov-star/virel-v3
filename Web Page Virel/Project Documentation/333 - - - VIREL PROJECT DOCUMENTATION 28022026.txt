Проект стартовал как переработка существующей системы в полноценную платформу для эскорт-агентства. Стек: **Next.js 14 (App Router), TypeScript, Prisma ORM, PostgreSQL (Neon), Cloudflare R2, Vercel**.

---

## Этап 1 — База и модели

**Что делали:**
- Настроили схему Prisma: таблицы `Model`, `ModelStats`, `ModelMedia`, `Location`, `Service`, `ModelService`, `Booking`, `Inquiry`, `User`
- Создали API роуты `/api/v1/models` для листинга и `/api/v1/models/[id]` для получения полной анкеты
- Сделали страницу `/catalog/[slug]` — публичный профиль модели с фото, stats, rates, booking form

**Проблемы:**
- Prisma schema не совпадала с реальными колонками в БД — часть таблиц была в snake_case, часть в camelCase. Это вызывало ошибки типа `column "model_id" does not exist`, `Unknown field category`
- API крашился из-за `include: { service: { include: { category: true } } }` — relation `category` не существует в схеме Service

**Решение:**
- Убрали несуществующие relations из include
- Все raw SQL запросы переписали с учётом реального регистра колонок (`"modelId"`, `"serviceId"`, `"isEnabled"`)
- Обернули все raw запросы в try/catch чтобы не падать если таблица ещё не создана

**Как избежать в будущем:**
- Перед деплоем запускать `npx prisma db pull` чтобы схема соответствовала реальной БД
- Не смешивать camelCase и snake_case в одном проекте

---

## Этап 2 — Media Upload (Cloudflare R2)

**Что делали:**
- Настроили Cloudflare R2 bucket `virel-media`
- Создали API `/api/upload` — принимает файл, загружает в R2, возвращает публичный URL
- Сделали компонент `MediaTab` с drag & drop, превью галереей, кнопкой удаления
- Публичный CDN: `pub-5deecadad4ab46f9bf12b2691c52ec6d.r2.dev`

**Проблемы:**
- R2 SDK требует специфической конфигурации — `endpoint`, `region: 'auto'`, credentials через env
- Vercel не видел env переменные R2 при деплое — пришлось добавлять через Vercel Dashboard вручную
- `forcePathStyle: true` обязательно для R2, без него запросы шли на AWS

**Решение:**
- Прописали все R2 переменные в `.env` и в Vercel Dashboard
- Добавили `forcePathStyle: true` в S3Client конфиг

**Как избежать в будущем:**
- Сразу добавлять все env переменные в Vercel при настройке, не ждать ошибок на проде

---

## Этап 3 — Аутентификация Admin панели

**Что делали:**
- Сначала попробовали NextAuth — не заработал стабильно с App Router
- Выкинули NextAuth, написали простую JWT авторизацию вручную
- API `/api/auth/login` — принимает email/password, верифицирует bcrypt, ставит httpOnly cookie `virel-token`
- Middleware проверяет cookie на всех `/admin/*` роутах, редиректит на `/admin/login` если нет
- Скрипт `create-admin-user.js` создаёт пользователя в БД с хэшем пароля

**Проблемы:**
- Login страница рендерилась внутри Admin Layout (с sidebar) — выглядело сломано
- После логина `router.push()` не применял cookie до следующего рендера — оставался на login
- Middleware редиректил на `/admin/dashboard` которого не существовало

**Решение:**
- Создали отдельный `layout.tsx` для `/admin/login` который не наследует Admin Layout
- Заменили `router.push()` на `window.location.href` для hard redirect после логина
- Middleware теперь редиректит на `/admin/models`

**Как избежать в будущем:**
- Login страницы всегда выносить из основного layout через отдельный `layout.tsx`
- После set-cookie всегда делать hard redirect, не использовать client-side navigation

---

## Этап 4 — SEO страницы

**Что делали:**
- 58 страниц районов Лондона: `/escorts-in/[district]` — Mayfair, Kensington, Chelsea и т.д.
- 99 страниц услуг: `/services/[service]` — все категории (classic, massage, BDSM, fetish, oral, entertainment)
- Каждая страница: H1, описание, JSON-LD schema, FAQ секция, breadcrumbs, internal linking
- `sitemap.xml` с динамическим включением всех моделей, районов, услуг
- Google Search Console: файл верификации + meta tag в layout

**Проблемы:**
- Роутинг был неправильный — папка называлась `escorts-in-[district]` вместо `escorts-in/[district]` — все 404
- Sitemap генерировал неправильные URL после исправления роутинга

**Решение:**
- Переименовали папки, обновили все внутренние ссылки и sitemap
- Верифицировали сайт в Google Search Console, отправили sitemap

**Как избежать в будущем:**
- Перед созданием 50+ страниц проверять роутинг на 1-2 тестовых страницах

---

## Этап 5 — Система заявок моделей

**Что делали:**
- Публичная форма `/join` — модель заполняет анкету: имя, возраст, параметры, услуги, фото
- Back-office `/admin/applications` — менеджер просматривает заявки, меняет статус (pending → approved/rejected)
- API `/api/applications` — сохраняет в БД, отправляет уведомление
- AI подсказки имён в форме создания модели — Claude API генерирует 6 вариантов псевдонима по введённым буквам

**Проблемы:**
- AI name suggestions делали прямой вызов Anthropic API из браузера — работало, но ключ API не должен быть на клиенте (в данном случае ключ не передаётся, вызов идёт через proxy)

---

## Этап 6 — Создание моделей через API

**Что делали:**
- API `/api/admin/models` POST — создаёт модель полностью: запись в `models`, `model_stats`, `model_rates`, привязка локации
- Скрипт `create-admin-user.js` для создания admin пользователя
- Скрипты для batch-создания моделей из анкет

**Проблемы и решения:**

1. **Сервисы не отображались на профиле** — страница `/catalog/[slug]` вообще не делала запрос к `model_services`. Добавили SQL запрос и блок Services на страницу.

2. **Сервисы не привязывались при создании** — API вставлял слаги напрямую в поле которого нет, вместо того чтобы искать `service.id` по слагу. Исправили: API делает `findMany` по слагам и вставляет правильные ID.

3. **Неправильные слаги в скриптах** — использовали слаги которых нет в БД (`b2b`, `filming-mask`, `light-domination` вместо `light-dom`). Нужно было сначала получить полный список слагов из БД.

4. **camelCase vs snake_case в raw SQL** — колонки `modelId`, `serviceId`, `isEnabled` требуют кавычек в PostgreSQL иначе ошибка `column does not exist`.

**Как избежать в будущем:**
- Перед написанием скриптов с сервисами — всегда сначала dump всех слагов из БД
- В raw SQL всегда использовать `"camelCase"` с кавычками

---

## Этап 7 — Публичные страницы

**Что делали:**
- Header: ссылки Companions, Services, FAQ, Contact, Join Us
- Footer: ссылки на районы, услуги, информационные страницы, контакты
- `/faq` — 10 вопросов с accordion
- `/contact` — Telegram, WhatsApp, Email
- `/terms` и `/privacy` — юридические страницы (noindex)

**Проблемы:**
- Header и Footer содержали ссылки на несуществующие страницы (`/catalog`, `/about`, `/areas`) — все 404
- Исправили: заменили на реально существующие роуты

---

## Текущее состояние

**Работает:**
- Публичный сайт: главная, каталог, профили моделей, 99 услуг, 58 районов
- Admin панель: логин, список моделей, редактор профиля (6 табов), загрузка фото
- Создание моделей через скрипты
- Google Search Console верифицирован, sitemap отправлен
- Модели в БД: Sophia, Comely, Raposa, Watari (Dysis и Inglote не создались — скрипт запускался дважды, нужно повторить)

**Не готово:**
- Фото моделей — нет механизма автозагрузки из Google Drive, нужно загружать вручную через Media tab или написать скрипт с Google Drive API + R2
- Сервисы у части моделей не привязаны правильно (неправильные слаги)
- Dysis и Inglote не созданы

---

## Главные уроки

1. **Всегда проверять схему БД перед написанием запросов** — `npx prisma db pull` или dump колонок
2. **Слаги сервисов** — перед любым скриптом делать dump из БД, не угадывать
3. **Raw SQL с camelCase** — обязательно в кавычках: `"modelId"`, `"serviceId"`
4. **Login страница** — отдельный layout, hard redirect после авторизации
5. **Роутинг** — проверять на 1 странице перед массовым созданием
6. **Env переменные** — сразу добавлять везде (`.env` + Vercel Dashboard), не ждать ошибок на проде
7. **Try/catch в API** — все raw запросы к таблицам вне Prisma schema оборачивать, иначе 500 на весь endpoint